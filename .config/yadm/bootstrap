#!/bin/sh

set -eu

# utils
is_installed () {
    local package=$1
    local bin=${2:-$package}

    command -v $bin &> /dev/null
}

# dirname $0 && pwd -P ??? https://bytexd.com/what-is-dirname-0-and-usage-examples/
# BOOTSTRAP_D="${BASH_SOURCE[0]:-${(%):-%x}}.d"
BOOTSTRAP_D="$0.d"

if [[ ! -d "$BOOTSTRAP_D" ]]; then
    echo "Error: bootstrap directory '$BOOTSTRAP_D' not found" >&2
    exit 1
fi

find -L "$BOOTSTRAP_D" -type f | sort  -n | while IFS= read -r bootstrap; do
    if [[ -x "$bootstrap" && ! "$bootstrap" =~ "##" && ! "$bootstrap" =~ "~$" ]]; then
        echo "Executing $bootstrap"
        . $bootstrap
        if ! [ "$?" ]; then
            echo "Error: bootstrap '$bootstrap' failed" >&2
            exit 1
        fi
    fi
done
